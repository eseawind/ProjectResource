{"title":"数据库浏览器","inframe":true,"hidden":false,"roles":{"demo":1},"pageLink":"","children":[{"configs":{"itemId":"module"},"events":{"initialize":"Wb.apply(app, {\n  /** 运行 SQL 语句 */\n  runSql: function(jndi, sql, title, fromSql) {\n    app.fromSql = fromSql;\n    app.currentSql = sql;\n    app.gridPage = app.viewport1.add(app._gridPage);\n    app.gridPage.setTitle(title);\n    if (fromSql)\n      app.gridPage.setEditButtons(false);\n    app.sqlStore.load({\n      params: {\n        jndi: jndi,\n        sql: sql\n      },\n      callback: function(a, b, succ) {\n        if (succ)\n          app.viewport1.setActiveItem(app.gridPage);\n      }\n    });\n  },\n  /** 添加记录 */\n  addRecord: function() {\n    app.gridPage.addRecord();\n  },\n  /** 刷新表格 */\n  refreshGrid: function() {\n    var store = app.gridPage.store;\n    store.setClearOnPageLoad(true);\n    store.loadPage(1);\n    store.setClearOnPageLoad(false);\n  },\n  //部分手机浏览器如果不支持下载操作可以使用内置浏览器或直接使用webview加壳\n  /** 导出 GZ */\n  exportGZ: function() {\n    Wb.download('m?xwl=apps/sys/tools/tdbe/export', {\n      sql: app.currentSql,\n      jndi: app.jndi,\n      filename: app.fromSql ? 'data.gz' : app.table + '.gz'\n    });\n  },\n  /** 导入 GZ */\n  importGZ: function() {\n    app.doUpload = app.doImportGZ;\n    app.trans.setHidden(false);\n    app.file.setAccept('application/gzip');\n    app.viewport1.setActiveItem(app.uploadPage);\n  },\n  /** 导入数据至指定表 */\n  doImportGZ: function() {\n    if (!Wb.verify(app.uploadPage))\n      return;\n    Wb.upload({\n      form: app.uploadPage,\n      url: 'm?xwl=apps/sys/tools/tdbe/import',\n      params: {\n        table: app.table,\n        jndi: app.jndi\n      },\n      success: function() {\n        app.file.reset();\n        app.viewport1.setActiveItem(app.gridPage);\n        app.gridPage.store.reload();\n      }\n    });\n  },\n  /** 导出 Excel */\n  exportExcel: function() {\n    Wb.exportData(app.gridPage, 'excel', true);\n  },\n  /** 导出 Text */\n  exportText: function() {\n    Wb.exportData(app.gridPage, 'text', true);\n  },\n  /** 查看属性 */\n  viewProperties: function() {\n    app.viewport1.setActiveItem(app.propertyPage);\n    if (app.sqlStore._proxy._reader.rawData) {\n      var cols = app.sqlStore._proxy._reader.rawData.columns,\n        store = app.propertyStore;\n      store.setData(cols);\n      store.removeAt(0);\n    } else\n      Wb.warn('表格无数据。');\n  },\n  /** 设置过滤条件 */\n  setFilter: function() {\n    app.viewport1.setActiveItem(app.filterPage);\n  },\n  downloadBlob: function(fieldName, rowIndex) {\n    var grid = this;\n    Wb.download('m?xwl=apps/sys/tools/tdbe/download-blob', Ext.apply({\n      __jndi: app.jndi,\n      __tableName: app.table,\n      __fieldName: fieldName\n    }, Wb.getData(grid.store.getAt(rowIndex), true)));\n  },\n  uploadBlob: function(fieldName, rowIndex) {\n    app.uploadFieldName = fieldName;\n    app.uploadRowIndex = rowIndex;\n    app.uploadGrid = this;\n    app.doUpload = app.doUploadBlob;\n    app.trans.setHidden(true);\n    app.file.setAccept('');\n    app.viewport1.setActiveItem(app.uploadPage);\n  },\n  doUploadBlob: function() {\n    var grid = app.uploadGrid,\n      fieldName = app.uploadFieldName,\n      rowIndex = app.uploadRowIndex,\n      rec = grid.store.getAt(rowIndex);\n\n    if (!Wb.verify(app.uploadPage))\n      return;\n    Wb.upload({\n      form: app.uploadPage,\n      url: 'm?xwl=apps/sys/tools/tdbe/upload-blob',\n      params: Ext.apply({\n        __jndi: app.jndi,\n        __tableName: app.table,\n        __fieldName: fieldName\n      }, Wb.getData(rec, true)),\n      success: function() {\n        app.file.reset();\n        app.viewport1.setActiveItem(app.gridPage);\n        rec.set(fieldName, 'blob');\n        rec.commit();\n      }\n    });\n  },\n  removeBlob: function(fieldName, rowIndex) {\n    var grid = this,\n      rec = grid.store.getAt(rowIndex);\n    Wb.confirm('确定要删除该记录字段 \u201c' + fieldName + '\u201d 的内容吗？', function() {\n      Wb.request({\n        url: 'm?xwl=apps/sys/tools/tdbe/clear-blob',\n        params: Ext.apply({\n          __jndi: app.jndi,\n          __tableName: app.table,\n          __fieldName: fieldName\n        }, Wb.getData(rec, true)),\n        success: function(resp) {\n          rec.set(fieldName, '');\n          rec.commit();\n        }\n      });\n    });\n  },\n  dateRenderer: function(date) {\n    var str, category = this.initialConfig.category;\n    if (category == 'time')\n      return Wb.format(date, 'H:i:s');\n    else if (category == 'date')\n      return Wb.format(date, 'Y-m-d');\n    else {\n      //timestamp\n      str = Wb.dateToStr(date);\n      if (Ext.String.endsWith(str, '00:00:00.000'))\n        return str.substring(0, 10);\n      else if (Ext.String.endsWith(str, '.000'))\n        return str.substring(0, 19);\n      else return str;\n    }\n  }\n});"},"children":[{"configs":{"rowNumber":"true","itemId":"gridPage","loadColumns":"none","editable":"true","createInstance":"false"},"events":{"painted":"if (!app.fromSql) {\n  var me = this;\n  me.downloadBlob = app.downloadBlob;\n  me.uploadBlob = app.uploadBlob;\n  me.removeBlob = app.removeBlob;\n}","tapdelete":"Wb.confirm('确定要删除该记录吗？', function() {\n  var params = {\n    table: app.table,\n    jndi: app.jndi,\n    destroy: Wb.getData([record], true)\n  };\n  Wb.request({\n    url: 'm?xwl=apps/sys/tools/tdbe/save',\n    params: params,\n    success: function(resp) {\n      grid._store.remove(record);\n      sheet.hide();\n    }\n  });\n});","tapcancel":"sheet.hide();","tapok":"if (!Wb.verify(form))\n  return;\nvar values, params = {\n  table: app.table,\n  jndi: app.jndi\n};\nvalues = Wb.getValue(form);\nif (record) {\n  //修改\n  Ext.applyIf(values, Wb.getData(record, true));\n  //删除filefield字段，因为在form中提交实际文件数据\n  Wb.each(form.query('filefield'), function(field) {\n    delete values[field.itemId];\n  });\n  params.update = [values];\n} else {\n  //添加\n  params.create = [values];\n}\nvalues = Wb.getValue(form, null, true); //重新获取包含文件名称的values，用于更新记录\nWb.upload({\n  url: 'm?xwl=apps/sys/tools/tdbe/save',\n  form: form,\n  params: params,\n  success: function(resp) {\n    if (record)\n      record.set(values);\n    else\n      record = grid.store.add(values)[0];\n    record.commit();\n    sheet.hide();\n  }\n});"},"children":[{"configs":{"clearOnPageLoad":"false","normalName":"sqlStore","itemId":"store","url":"m?xwl=apps/sys/tools/tdbe/execute"},"events":{"success":"if (!store.columnsLoaded) {\n  var cols = Wb.getColumns(store);\n  Wb.each(cols, function(col) {\n    if (col.width)\n      col.width = Math.round(col.width * 1.2);\n    else if (col.flex)\n      col.width = 200;\n    if (col.editor) {\n      switch (col.category) {\n        case 'timestamp':\n          col.editor.xtype = 'datetimefield';\n          col.editor.type = 'auto';\n          col.renderer = app.dateRenderer;\n          break;\n        case 'date':\n          col.editor.xtype = 'datetimefield';\n          col.editor.type = 'date';\n          col.editor.format = 'Y-m-d';\n          col.renderer = app.dateRenderer;\n          break;\n        case 'time':\n          col.editor.xtype = 'datetimefield';\n          col.editor.type = 'time';\n          col.editor.format = 'H:i:s';\n          col.renderer = app.dateRenderer;\n          break;\n      }\n    }\n  });\n  app.gridPage.updateColumns(cols);\n  store.columnsLoaded = true;\n}"},"children":[],"type":"tstore","expanded":false},{"configs":{"itemId":"titleBar"},"children":[{"configs":{"align":"left","glyph":"f053","itemId":"back"},"events":{"tap":"//app.gridPage.store.destroy(); store默认随容器自动destroy，由属性destroyByOwer指定\napp.gridPage.destroy();\nif (app.fromSql)\n  app.viewport1.setActiveItem(app.sqlPage);"},"children":[],"type":"tbutton","expanded":false},{"configs":{"align":"right","glyph":"f0c9","itemId":"menu"},"events":{"tap":"app.gridMenu.showBy(button);"},"children":[],"type":"tbutton","expanded":false}],"type":"ttitlebar","expanded":true}],"type":"tgrid","expanded":true},{"configs":{"height":"240","hidden":"true","layout":"fit","width":"180","left":"0","itemId":"gridMenu","modal":"true","hideOnMaskTap":"true","top":"0"},"events":{"show":"if (app.fromSql) {\n  app.dataview1.store.filter('forSQL', true);\n  app.gridMenu.setHeight(200);\n} else {\n  app.dataview1.store.clearFilter();\n  app.gridMenu.setHeight(320);\n}"},"children":[{"configs":{"itemTpl":"@Wb.menuItem","scrollable":"false","padding":"8","itemId":"dataview1"},"events":{"itemtap":"app.gridMenu.hide();\nrecord.get('handler')();"},"children":[{"configs":{"data":" [{\n   text: '添加记录',\n   glyph: 'f067',\n   handler: app.addRecord\n }, {\n   text: '过滤',\n   glyph: 'f0b0',\n   handler: app.setFilter\n }, {\n   text: '导入 GZ 文件',\n   glyph: 'f0ab',\n   handler: app.importGZ\n }, {\n   text: '导出 GZ 文件',\n   forSQL: true,\n   glyph: 'f0aa',\n   handler: app.exportGZ\n }, {\n   text: '导出 Excel 文件',\n   forSQL: true,\n   glyph: 'f1c3',\n   handler: app.exportExcel\n }, {\n   text: '导出文本文件',\n   forSQL: true,\n   glyph: 'f016',\n   handler: app.exportText\n }, {\n   text: '属性',\n   forSQL: true,\n   glyph: 'f05a',\n   handler: app.viewProperties\n }, {\n   text: '刷新',\n   forSQL: true,\n   glyph: 'f021',\n   handler: app.refreshGrid\n }]","itemId":"store","fields":"['text', 'glyph', 'handler', 'forSQL']"},"children":[],"type":"tstore","expanded":false}],"type":"tdataview","expanded":true}],"type":"tpanel","expanded":true},{"configs":{"appImage":"wb/images/icon/db.png","layout":"card","itemId":"viewport1"},"events":{"destroy":"//在thome中运行时销毁viewport之外的组件\n//Ext.destroy同comp.destroy的区别为能判断实例是否存在\nExt.destroy(app.gridPage);\nExt.destroy(app.gridMenu);"},"children":[{"configs":{"title":"数据库","itemId":"tableList"},"events":{"itemtap":"if (record.isLeaf()) {\n  app.table = record.get('text');\n  app.runSql(app.jndi, 'select * from ' + app.table, app.table, false);\n} else\n  app.jndi = record.get('jndi');","listchange":"var node = app.tableList._lastNode,\n  hidden = !(node && node.isRoot());\n//root to leaf show button\napp.sqlBtn.setHidden(hidden);\napp.schemeBtn.setHidden(hidden);"},"children":[{"configs":{"itemId":"store","url":"m?xwl=apps/sys/tools/tdbe/get-tree","fields":"['text', 'jndi', 'schem', 'table']"},"events":{"beforeload":"operation._params.jndi = operation._node.data.jndi;"},"children":[],"type":"ttreestore","expanded":false},{"configs":{"docked":"top","itemId":"toolbar"},"children":[{"configs":{"text":"SQL","align":"right","itemId":"sqlBtn"},"events":{"tap":"app.viewport1.setActiveItem(app.sqlPage);"},"children":[],"type":"tbutton","expanded":false},{"configs":{"text":"方案","align":"right","itemId":"schemeBtn"},"events":{"tap":"var store = app.tableList._store,\n  hasSchem = !store._params.hasSchem;\nstore._params.hasSchem = hasSchem;\nstore._root.cascadeBy(function(node) {\n  if (node.isLeaf()) {\n    node.set('text', hasSchem && !Wb.isEmpty(node.data.schem) ?\n      (node.data.schem + '.' + node.data.table) : node.data.table);\n    node.commit();\n  }\n});"},"children":[],"type":"tbutton","expanded":false}],"type":"ttitlebar","expanded":true}],"type":"tnlist","expanded":true},{"configs":{"layout":"fit","itemId":"sqlPage"},"events":{"resize":"app.sqlText.setHeight(app.sqlPage.innerElement.getHeight());"},"children":[{"configs":{"title":"SQL","docked":"top","itemId":"titlebar1"},"children":[{"configs":{"text":"返回","align":"left","glyph":"f053","itemId":"back"},"events":{"tap":"app.viewport1.setActiveItem(app.tableList);"},"children":[],"type":"tbutton","expanded":false},{"configs":{"ui":"action","text":"运行","align":"right","glyph":"f04b","itemId":"run"},"events":{"tap":"app.runSql(app.jndi, app.sqlText.getValue(), 'SQL', true);"},"children":[],"type":"tbutton","expanded":false}],"type":"ttitlebar","expanded":true},{"configs":{"xtype":"textareafield","itemId":"sqlText"},"children":[],"type":"ttext","expanded":false}],"type":"tcontainer","expanded":true},{"configs":{"itemId":"uploadPage"},"children":[{"configs":{"title":"导入","docked":"top","itemId":"titlebar1"},"children":[{"configs":{"text":"返回","align":"left","glyph":"f053","itemId":"back"},"events":{"tap":"app.viewport1.setActiveItem(app.gridPage);"},"children":[],"type":"tbutton","expanded":false},{"configs":{"ui":"action","text":"导入","align":"right","glyph":"f0ab","itemId":"import"},"events":{"tap":"app.doUpload();"},"children":[],"type":"tbutton","expanded":false}],"type":"ttitlebar","expanded":true},{"configs":{"label":"文件","required":"true","itemId":"file"},"children":[],"type":"tfile","expanded":false},{"configs":{"value":"true","label":"使用事务","itemId":"trans"},"children":[],"type":"ttoggle","expanded":false}],"type":"tform","expanded":true},{"configs":{"title":"属性","rowNumber":"true","itemId":"propertyPage"},"children":[{"configs":{"normalName":"propertyStore","itemId":"store","fields":"['dataIndex', 'metaType', 'metaSize', 'metaScale', 'metaRequired']"},"children":[],"type":"tstore","expanded":false},{"configs":{"itemId":"titleBar"},"children":[{"configs":{"text":"返回","align":"left","glyph":"f053","itemId":"back"},"events":{"tap":"app.viewport1.setActiveItem(app.gridPage);"},"children":[],"type":"tbutton","expanded":false}],"type":"ttitlebar","expanded":true},{"configs":{"itemId":"columns"},"children":[{"configs":{"width":"30","xtype":"rownumberer","itemId":"numCol"},"children":[],"type":"tcolumn","expanded":false},{"configs":{"text":"字段名称","width":"230","dataIndex":"dataIndex","itemId":"nameCol","renderer":"if (record.get('metaRequired'))\n  return '<b>' + value + '<\/b>';\nelse return value;"},"children":[],"type":"tcolumn","expanded":false},{"configs":{"text":"类型","width":"120","dataIndex":"metaType","itemId":"typeCol"},"children":[],"type":"tcolumn","expanded":false},{"configs":{"text":"大小","width":"120","align":"right","dataIndex":"metaSize","itemId":"sizeCol"},"children":[],"type":"tcolumn","expanded":false},{"configs":{"text":"精度","width":"60","align":"right","dataIndex":"metaScale","itemId":"scaleCol"},"children":[],"type":"tcolumn","expanded":false},{"configs":{"text":"必填","width":"60","xtype":"booleancolumn","falseText":"否","dataIndex":"metaRequired","itemId":"requiredCol","trueText":"是"},"children":[],"type":"tcolumn","expanded":false}],"type":"array","expanded":true}],"type":"tgrid","expanded":true},{"configs":{"layout":"fit","itemId":"filterPage"},"events":{"resize":"app.filterText.setHeight(app.filterPage.innerElement.getHeight());"},"children":[{"configs":{"title":"过滤","docked":"top","itemId":"titlebar1"},"children":[{"configs":{"text":"返回","align":"left","glyph":"f053","itemId":"back"},"events":{"tap":"app.viewport1.setActiveItem(app.gridPage);"},"children":[],"type":"tbutton","expanded":false},{"configs":{"ui":"action","text":"确定","align":"right","glyph":"f00c","itemId":"ok"},"events":{"tap":"var whereSql = app.filterText.getValue();\nif (whereSql)\n  whereSql = ' where ' + whereSql;\napp.sqlStore.load({\n  params: {\n    jndi: app.jndi,\n    sql: 'select * from ' + app.table + whereSql\n  }\n});\napp.viewport1.setActiveItem(app.gridPage);"},"children":[],"type":"tbutton","expanded":false}],"type":"ttitlebar","expanded":true},{"configs":{"xtype":"textareafield","itemId":"filterText"},"children":[],"type":"ttext","expanded":false}],"type":"tcontainer","expanded":true}],"type":"tviewport","expanded":true}],"type":"module","expanded":true}],"iconCls":"seek_icon"}