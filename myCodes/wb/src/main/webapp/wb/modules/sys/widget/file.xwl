{"inframe":false,"title":"文件管理器","hidden":false,"roles":{"demo":1},"children":[{"configs":{"serverScript":"//获取指定的根目录\nvar sysFolderBase = String(Var.getString(\"sys.ide.sysFolderBase\"));\nswitch (sysFolderBase) {\n  case 'app':\n    sysFolderBase = FileUtil.getPath(Base.path);\n    break;\n  case 'server':\n    sysFolderBase = FileUtil.getPath(Base.path.getParentFile().getParent());\n    break;\n  default:\n    request.setAttribute('appPath', FileUtil.getPath(Base.path));\n    sysFolderBase = '';\n}\nrequest.setAttribute('sysFolderBase', sysFolderBase);","itemId":"module"},"events":{"initialize":"Wb.apply(app, {\n  /** 根路径类型 */\n  baseType: '{#Var.sys.ide.sysFolderBase#}',\n  /** 根路径 */\n  basePath: '{#sysFolderBase#}',\n  /** 文件多选标识 */\n  multiSelect: true,\n  /**\n   * 获取文件列表中文件节点的绝对路径。\n   * @param {NodeInterface} node 节点对象，如果未指定节点则使用选择的节点。\n   * @return {String} 绝对路径。\n   */\n  getPath: function(node) {\n    if (!node || node.isRoot()) return '';\n    var path = Wb.getSection(node.getPath('text'), '/', 2);\n    path = app.basePath ? (app.basePath + '/' + path) : path;\n    return path.replace('//', '/');\n  },\n  openFile: function() {\n    var fileNames = app.getFileNames();\n    if (Wb.isEmpty(fileNames)) {\n      Wb.warn('请选择至少一个文件。');\n      return;\n    }\n    Wb.each(fileNames, function(fileName) {\n      var encodeFileName = encodeURIComponent(fileName).replace(/\\(/g, '%28').replace(/\\)/g, '%29');\n      Wb.open({\n        url: 'text-editor?f=' + encodeFileName, //f仅用于标识url，使二次打开时自动定位到原文件tab\n        params: {\n          file: fileName\n        },\n        newTab: false,\n        title: Ext.String.ellipsis(Wb.getFilename(fileName), 20),\n        icon: 'm?xwl=sys/widget/file/get-file-icon&file=' + encodeFileName,\n        tooltip: fileName\n      });\n    });\n  },\n  selectPath: function(path, callback) {\n    path = '/Root/' + path.replace(/\\\\/g, '/');\n    if (Ext.String.endsWith(path, '/'))\n      path = path.slice(0, -1);\n    if (app.baseType == 'root') {\n      path = path.split('/');\n      path[2] = path[2] + '/'; //系统根目录补上/，适用所有操作系统\n      app.fileTree.selectPath(path.join('\\n'), 'text', '\\n', callback);\n    } else app.fileTree.selectPath(path, 'text', '/', callback);\n  },\n  createFile: function(isDir) {\n    Wb.prompt({\n      title: isDir ? '新建文件夹' : '新建文件',\n      iconCls: isDir ? 'folder_add_icon' : 'file_add_icon',\n      items: {\n        itemId: 'name',\n        allowBlank: false,\n        fieldLabel: isDir ? '文件夹名称' : '文件名称'\n      },\n      handler: function(values, win) {\n        var node = app.fileTree.getSelection()[0];\n        if (node.isLeaf())\n          node = node.parentNode;\n        Wb.request({\n          url: 'm?xwl=sys/widget/file/add-file',\n          params: {\n            isDir: isDir,\n            path: app.getPath(node),\n            name: values.name\n          },\n          success: function(resp) {\n            var loaded = node.data.loaded,\n              object = Wb.decode(resp.responseText);\n            if (isDir && node.isLoaded()) {\n              node.appendChild({\n                text: values.name,\n                children: []\n              }).commit();\n            }\n            Wb.add(app.fileGrid, Wb.apply(object, {\n              text: values.name,\n              leaf: !isDir\n            }));\n            win.close();\n          }\n        });\n      }\n    });\n  },\n  rename: function() {\n    var win, nameField, oldName, sels = app.fileGrid.getSelection(),\n      node = app.fileTree.getSelection()[0];\n    if (sels.length != 1) {\n      Wb.warn('请选择一个文件或目录。');\n      return;\n    }\n    sels = sels[0];\n    oldName = sels.data.text;\n    win = Wb.prompt({\n      title: '重命名 - ' + oldName,\n      focusControl: null,\n      iconCls: 'rename_icon',\n      items: {\n        itemId: 'name',\n        allowBlank: false,\n        fieldLabel: '新名称',\n        value: oldName\n      },\n      handler: function(values, win) {\n        if (oldName == values.name) {\n          win.close();\n          return;\n        }\n        Wb.request({\n          url: 'm?xwl=sys/widget/file/rename',\n          params: {\n            path: app.getPath(node),\n            oldName: oldName,\n            newName: values.name\n          },\n          success: function(resp) {\n            var obj = Wb.decode(resp.responseText);\n            Wb.update(sels, {\n              text: values.name,\n              icon: obj.icon\n            });\n            if (!sels.data.leaf && node.isLoaded()) {\n              //更新tree上的名称\n              var sub = node.findChild('text', oldName);\n              sub.set('text', values.name);\n              sub.commit();\n            }\n            win.close();\n          }\n        });\n      }\n    });\n    nameField = win.down('#name');\n    nameField.focus(false, true, function() {\n      var pos = oldName.lastIndexOf('.');\n      if (pos == -1) pos = oldName.length;\n      nameField.selectText(0, pos);\n    });\n\n  },\n  deleteFiles: function() {\n    var node = app.fileTree.getSelection()[0],\n      files = app.fileGrid.getSelection();\n    Wb.confirmDo(files, function() {\n      Wb.request({\n        url: 'm?xwl=sys/widget/file/delete',\n        timeout: -1,\n        out: app.fileGrid,\n        params: {\n          path: app.getPath(node)\n        },\n        success: function(resp) {\n          Wb.remove(app.fileGrid);\n          if (node.isLoaded()) {\n            Wb.each(files, function(file) {\n              var child = node.findChild('text', file.data.text);\n              if (child) child.remove();\n            });\n          }\n        }\n      });\n    });\n  },\n  copyFiles: function(isCut) {\n    var fileNames = app.getFileNames(null, true),\n      node = app.fileTree.getSelection()[0];\n    if (!fileNames.length) {\n      Wb.warn('请选择至少一个文件/目录。');\n      return;\n    }\n    app.clipboard = fileNames;\n    if (isCut && node.isLoaded()) {\n      app.cutNodes = [];\n      Wb.each(fileNames, function(fileName) {\n        app.cutNodes.push(node.findChild('text', Wb.getFilename(fileName)));\n      });\n    }\n    app.isCut = isCut;\n  },\n  pasteFiles: function() {\n    if (!app.clipboard || !app.clipboard.length) {\n      Wb.warn('没有可以粘贴的文件/目录。');\n      return;\n    }\n    var dstNode = app.fileTree.getSelection()[0];\n    Wb.request({\n      url: 'm?xwl=sys/widget/file/paste',\n      timeout: -1,\n      params: {\n        isCut: app.isCut,\n        src: app.clipboard,\n        dst: app.getPath(dstNode)\n      },\n      success: function(resp) {\n        Ext.suspendLayouts();\n        if (app.isCut) {\n          app.clipboard = null;\n          Wb.each(app.cutNodes, function(node) {\n            if (node)\n              node.remove();\n          });\n        }\n        var index, oldItems = [],\n          items = Wb.decode(resp.responseText);\n        if (dstNode.isLoaded()) {\n          Wb.each(items, function(item) {\n            if (!item.leaf && !dstNode.findChild('text', item.text)) {\n              dstNode.appendChild({\n                text: item.text,\n                children: []\n              }).commit();\n            }\n          });\n        }\n        Wb.each(items, function(item) {\n          index = app.gridStore.findExact('text', item.text);\n          if (index != -1)\n            oldItems.push(app.gridStore.getAt(index));\n        });\n        app.gridStore.remove(oldItems);\n        Wb.add(app.fileGrid, items);\n        Ext.resumeLayouts(true);\n      }\n    });\n  },\n  getFileNames: function(extName, includeFolder) {\n    function addExtName(filename) {\n      if (!extName)\n        return filename;\n      if (Ext.String.endsWith(filename.toLowerCase(), lowerExtName))\n        return filename;\n      else return filename + extName;\n    }\n    var rows, lowerExtName = extName ? extName.toLowerCase() : null,\n      fileNames, path = app.getPath(app.fileTree.getSelection()[0]);\n    if (!Ext.String.endsWith(path, '/'))\n      path += '/';\n    if (!includeFolder && !app.multiSelect)\n      return [path + addExtName(app.fileNameText.getValue())];\n    rows = app.fileGrid.getSelection();\n    fileNames = [];\n    Wb.each(rows, function(row) {\n      if (includeFolder || row.data.leaf)\n        fileNames.push(path + row.data.text);\n    });\n    return fileNames;\n  },\n  exportFile: function(zip) {\n    //微信等如果禁止下载，可使用普通手机浏览器或webview来使用下载功能\n    var files = app.getFileNames(null, true);\n    if (!files.length) {\n      Wb.warn('请选择至少一个需要导出的文件或目录。');\n      return;\n    }\n    Wb.download('m?xwl=dev/ide/download', {\n      files: files,\n      zip: zip\n    });\n  },\n  importFile: function(unzip) {\n    var node = app.fileTree.getSelection()[0],\n      path = app.getPath(node);\n    Wb.run({\n      url: 'upload',\n      success: function(scope) {\n        Wb.highlight(node);\n        scope.upload({\n          url: 'm?xwl=dev/ide/upload',\n          iconCls: 'import_icon',\n          title: (unzip ? '导入并解压 - ' : '导入 - ') + node.data.text,\n          params: {\n            path: path,\n            unzip: unzip\n          },\n          beforeUpload: unzip ? function() {\n            if (!Ext.String.endsWith(scope.file.getValue().toLowerCase(), '.zip')) {\n              Wb.warn('请选择一个 zip 格式的文件。');\n              return false;\n            }\n          } : null,\n          success: function() {\n            Wb.reload(app.fileTree);\n          }\n        });\n      }\n    });\n  }\n});\napp.dblClickFileHandler = app.openFile;"},"children":[{"configs":{"layout":"fit","border":"false","itemId":"viewport1"},"events":{"afterrender":"var appPath = \"{#appPath#}\";\nif (appPath)\n  app.address.store.add({\n    field1: appPath\n  });\nWb.setNavigate(app.fileTree, app.backBtn, app.forwardBtn);\napp.navKey = new Ext.KeyNav({\n  component: viewport,\n  ignoreInputFields: true,\n  beforeCall: function(e) {\n    if (Wb.isModal()) {\n      e.stopEvent();\n      return false;\n    }\n  },\n  C: {\n    ctrl: true,\n    fn: function() {\n      app.copyFiles(false);\n    }\n  },\n  X: {\n    ctrl: true,\n    fn: function(e) {\n      app.copyFiles(true);\n    }\n  },\n  V: {\n    ctrl: true,\n    fn: app.pasteFiles\n  },\n  del: app.deleteFiles\n});"},"children":[{"configs":{"layout":"border","border":"false","itemId":"panel1"},"children":[{"configs":{"itemId":"dockedItems"},"children":[{"configs":{"enableOverflow":"true","itemId":"toolbar1","border":"false"},"children":[{"configs":{"anyMatch":"true","autoSelect":"false","pickList":"[]","itemId":"address","flex":"1"},"events":{"select":"app.goBtn.fireEvent('click');","specialkey":"if (e.getKey() == e.ENTER) {\n  app.goBtn.fireEvent('click');\n}"},"children":[],"expanded":false,"type":"combo"},{"configs":{"overflowText":"转到","itemId":"goBtn","iconCls":"go_icon","tooltip":"转到"},"events":{"click":"app.selectPath(app.address.getValue(), function(succ) {\n  if (succ)\n    Wb.save(app.address);\n});"},"children":[],"expanded":false,"type":"item"}],"expanded":true,"type":"toolbar"},{"configs":{"enableOverflow":"true","border":"false","itemId":"toolbar2"},"children":[{"configs":{"text":"新建文件","itemId":"newFileBtn","iconCls":"file_add_icon","tooltip":"在当前文件夹创建一个空的文件"},"events":{"click":"app.createFile(false);"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"新建文件夹","itemId":"newFolderBtn","iconCls":"folder_add_icon","tooltip":"在当前文件夹创建一个空的文件夹"},"events":{"click":"app.createFile(true);"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"重命名","itemId":"renameBtn","iconCls":"rename_icon","tooltip":"对选择的文件或文件夹重命名"},"events":{"click":"app.rename();"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"编辑","itemId":"editFileBtn","iconCls":"file_edit_icon","tooltip":"在线打开并编辑选择的文件"},"events":{"click":"app.openFile();"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"-","itemId":"item0"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"向上","itemId":"upBtn","iconCls":"upward_icon","tooltip":"返回上一级目录"},"events":{"click":"var node = app.fileTree.getSelection()[0];\nif (node && node.getDepth() > 1)\n  app.fileTree.setSelection(node.parentNode);"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"后退","itemId":"backBtn","iconCls":"left_icon","tooltip":"返回到上次目录"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"前进","itemId":"forwardBtn","iconCls":"right_icon","tooltip":"返回到后退前目录"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"-","itemId":"item1"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"剪切","itemId":"cutBtn","iconCls":"cut_icon","tooltip":"把选择的文件或文件夹剪切到剪贴板 (Ctrl+X)"},"events":{"click":"app.copyFiles(true);"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"复制","itemId":"copyBtn","iconCls":"copy_icon","tooltip":"把选择的文件或文件夹复制到剪贴板 (Ctrl+C)"},"events":{"click":"app.copyFiles(false);"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"粘贴","itemId":"pasteBtn","iconCls":"paste_icon","handler":"app.pasteFiles","tooltip":"在当前文件夹粘贴剪贴板中的文件或文件夹 (Ctrl+V)"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"删除","itemId":"deleteBtn","iconCls":"delete_icon","tooltip":"删除选择的文件或文件夹 (Delete)"},"events":{"click":"app.deleteFiles();"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"-","itemId":"item2"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"导出","xtype":"splitbutton","itemId":"exportBtn","iconCls":"export_icon","tooltip":"导出选择的文件或目录"},"events":{"click":"app.exportFile(false);"},"children":[{"configs":{"text":"压缩并导出","itemId":"zipExportBtn","iconCls":"file_zip_icon","tooltip":"对选择的文件或目录压缩后导出"},"events":{"click":"app.exportFile(true);"},"children":[],"expanded":false,"type":"item"}],"expanded":true,"type":"item"},{"configs":{"text":"导入","xtype":"splitbutton","itemId":"importBtn","iconCls":"import_icon","tooltip":"导入文件到当前目录"},"events":{"click":"app.importFile(false);"},"children":[{"configs":{"text":"导入并解压","itemId":"unzipExportBtn","iconCls":"file_zip_icon","tooltip":"导入文件并解压到当前目录"},"events":{"click":"app.importFile(true);"},"children":[],"expanded":false,"type":"item"}],"expanded":true,"type":"item"},{"configs":{"text":"-","itemId":"item3"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"刷新","itemId":"refreshBtn","iconCls":"refresh_icon","tooltip":"刷新所有的文件和文件夹"},"events":{"click":"Wb.reload(app.fileTree);"},"children":[],"expanded":false,"type":"item"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"statusBar","dock":"bottom"},"children":[{"configs":{"text":"&nbsp;","xtype":"tbtext","itemId":"fileSizeLabel"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"->","itemId":"item2"},"children":[],"expanded":false,"type":"item"},{"configs":{"xtype":"tbtext","itemId":"fileTotalLabel"},"children":[],"expanded":false,"type":"item"}],"expanded":false,"type":"toolbar"}],"expanded":true,"type":"array"},{"configs":{"region":"west","rootVisible":"false","collapsible":"true","width":"250","split":"true","itemId":"fileTree","header":"false"},"events":{"afterrender":"tree.getRootNode().expand();","selectionchange":"var node = selected[0],\n  path = app.getPath(node);\nif (node) {\n  app.address.setValue(app.basePath ? path.substring(app.basePath.length + 1) : path);\n  app.gridStore.load({\n    params: {\n      path: path\n    }\n  });\n} else app.gridStore.removeAll();"},"children":[{"configs":{"root":"{\n  expanded: false\n}","autoLoad":"false","normalName":"treeStore","itemId":"store","url":"m?xwl=sys/widget/file/get-files&mode=2"},"events":{"success":"if (app.baseType == 'app') {\n  if (!app.fileTree.selFirstDone) {\n    var wbNode = app.fileTree.getRootNode().findChild('text', 'wb');\n    if (wbNode)\n      app.fileTree.setSelection(wbNode);\n    app.fileTree.selFirstDone = true;\n  }\n} else\n  Wb.selFirst(app.fileTree);","beforeload":"var path, node = operation.node;\nif (node.isRoot())\n  path = app.basePath;\nelse\n  path = app.getPath(node);\noperation.params.path = path;"},"children":[],"expanded":false,"type":"treestore"}],"expanded":true,"type":"tree"},{"configs":{"region":"center","pagingBar":"false","multiSelect":"true","itemId":"fileGrid"},"events":{"itemdblclick":"var node = app.fileTree.getSelection()[0];\nif (node) {\n  if (record.data.leaf) {\n    app.dblClickFileHandler();\n  } else {\n    node.expand(false, function() {\n      var child = node.findChild('text', record.get('text'));\n      if (child)\n        app.fileTree.setSelection(child);\n      else {\n        Wb.warn('未找到目录\u201c' + record.get('text') + '\u201d，请刷新后再试一次。');\n      }\n    });\n  }\n}","selectionchange":"if (selected.length > 1) {\n  var items = Wb.format('选择 {0} 项', Wb.format(selected.length, '#,##0'));\n  app.fileSizeLabel.setText(items);\n  app.fileNameText.setValue(items);\n} else if (selected.length == 1) {\n  var rec = selected[0];\n  if (rec.data.leaf)\n    app.fileNameText.setValue(rec.data.text);\n  app.fileSizeLabel.setText(rec && rec.data.leaf ? (Wb.getFileSize(rec.data.size) + ' (' + rec.data.size + ' B)') : '&nbsp;');\n}","tagEvents":"{\n  itemkeydown: Wb.mimicClick\n}"},"children":[{"configs":{"pageSize":"-1","sorters":"'text'","normalName":"gridStore","itemId":"store","remoteSort":"true","url":"m?xwl=sys/widget/file/get-files&mode=3","fields":"['text', 'leaf', 'icon', 'type', {\n  name: 'size',\n  useNull: true\n}, {\n  name: 'date',\n  dateFormat: Wb.dateFormat,\n  type: 'date'\n}]"},"events":{"datachanged":"var folderCount = 0,\n  fileItems = [],\n  totalCount = app.gridStore.getCount();\napp.gridStore.each(function(rec) {\n  if (rec.data.leaf) {\n    fileItems.push({\n      field1: rec.data.text\n    });\n  } else {\n    folderCount++;\n  }\n});\napp.fileTotalLabel.setText('合计：' + Wb.format(totalCount, '#,##0') + '，文件夹：' + Wb.format(folderCount, '#,##0') +\n  '，文件：' + Wb.format(totalCount - folderCount, '#,##0'));\napp.fileNameText.store.loadData(fileItems);","success":"if (!app.fileNameText.firstFocused && app.fileNameText.isVisible()) {\n  app.fileNameText.firstFocused = true;\n  app.fileNameText.focus(false, true);\n}"},"children":[],"expanded":false,"type":"store"},{"configs":{"hidden":"true","normalName":"fileNameBar","itemId":"bbar"},"children":[{"configs":{"text":"文件名称：","xtype":"tbtext","itemId":"fileNameLbl"},"children":[],"expanded":false,"type":"item"},{"configs":{"store":"[]","anyMatch":"true","itemId":"fileNameText","flex":"1"},"children":[],"expanded":false,"type":"combo"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"xtype":"rownumberer","itemId":"numCol"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"名称","width":"280","dataIndex":"text","itemId":"nameCol","renderer":"var icon;\nif (record.get('leaf'))\n  icon = Wb.getUrlIcon('m?xwl=sys/widget/file/get-file-icon&file=' + record.get('icon'));\nelse icon = Wb.getIcon('x-tree-icon-parent');\nreturn icon + value;"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"大小","width":"90","align":"right","dataIndex":"size","itemId":"sizeCol","renderer":"return Wb.getFileSize(value);"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"类型","width":"150","dataIndex":"type","itemId":"typeCol"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"修改日期","width":"130","dataIndex":"date","itemId":"dateCol"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"panel"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":"explorer_icon"}