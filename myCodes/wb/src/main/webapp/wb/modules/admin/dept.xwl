{"inframe":false,"title":"部门管理","hidden":false,"roles":{"demo":1},"children":[{"configs":{"itemId":"module"},"events":{"initialize":"Wb.apply(app, {\n  treeViewConfig: {\n    plugins: {\n      ptype: 'treeviewdragdrop'\n    },\n    listeners: {\n      beforedrop: function(node, data, om, dp, dh) {\n        var i, index, parentNode, parentDept, selDepts, deptCount = data.records.length;\n        if (dp == 'append') {\n          parentNode = om;\n          index = om.lastChild ? om.lastChild.data.ORDER_INDEX + 1 : 1;\n        } else {\n          parentNode = om.parentNode;\n          index = dp == 'before' ? om.data.ORDER_INDEX : om.data.ORDER_INDEX + 1;\n        }\n        dh.wait = true;\n        parentDept = parentNode.data.DEPT_ID;\n        selDepts = Wb.getData(data.records);\n        i = 0;\n        Wb.each(selDepts, function(item) {\n          item.ORDER_INDEX = index + (i++);\n        });\n        Wb.request({\n          url: 'm?xwl=admin/dept/move',\n          params: {\n            index: index,\n            deptCount: deptCount,\n            parentDept: parentDept,\n            selDepts: selDepts\n          },\n          callback: function(a, succ) {\n            if (succ) {\n              dh.processDrop();\n              parentNode.eachChild(function(node) {\n                i = node.data.ORDER_INDEX;\n                if (i >= index)\n                  node.set('ORDER_INDEX', i + deptCount);\n              });\n              i = 0;\n              Wb.each(data.records, function(node) {\n                node.set('PARENT_DEPT', parentDept);\n                node.set('ORDER_INDEX', index + (i++));\n              });\n              app.tree1.setSelection(data.records);\n            } else {\n              dh.cancelDrop();\n            }\n          }\n        });\n      }\n    }\n  }\n});"},"children":[{"configs":{"height":"112","layout":"absolute","width":"416","itemId":"editWin","editWin":"true","defaultFocus":"DEPT_NAME"},"events":{"ok":"var values = Wb.getValue(app.editWin);\nif (app.isEdit) {\n  Wb.request({\n    url: 'm?xwl=admin/dept/update',\n    params: Wb.applyIf(values, Wb.getData(app.selNode, true)),\n    success: function() {\n      values.text = values.DEPT_NAME;\n      Wb.update(app.selNode, values);\n      app.editWin.close();\n    }\n  });\n} else {\n  Wb.request({\n    url: 'm?xwl=admin/dept/insert',\n    out: app.editWin,\n    params: {\n      PARENT_DEPT: app.selNode.data.DEPT_ID,\n      ORDER_INDEX: app.selNode.lastChild ? app.selNode.lastChild.data.ORDER_INDEX + 1 : 1\n    },\n    success: function(resp) {\n      app.selNode.expand();\n      app.selNode.appendChild(Wb.apply({\n        iconCls: 'db_field_icon',\n        text: values.DEPT_NAME,\n        children: []\n      }, Wb.decode(resp.responseText))).commit();\n      app.editWin.close();\n    }\n  });\n}"},"children":[{"configs":{"height":"22","allowBlank":"false","width":"376","labelAlign":"right","itemId":"DEPT_NAME","fieldLabel":"* 部门名称","y":"16","x":"0"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"window"},{"configs":{"layout":"border","itemId":"viewport1"},"events":{"afterrender":"app.navKey = new Ext.KeyNav({\n  viewport: app.viewport1,\n  E: {\n    ctrl: true,\n    fn: function() {\n      app.newBtn.fireEvent('click');\n    }\n  }\n});"},"children":[{"configs":{"region":"north","itemId":"toolbar1"},"children":[{"configs":{"text":"添加","itemId":"newBtn","iconCls":"record_add_icon","tooltip":"在当前节点下添加部门 (Ctrl+E)"},"events":{"click":"if (!app.selNode) {\n  Wb.warn('请选择 1 个部门。');\n  return;\n}\napp.editWin.setTitle('添加 - ' + app.selNode.data.text);\napp.editWin.setIconCls('record_add_icon');\napp.editWin.show();\napp.isEdit = false;"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"修改","itemId":"editBtn","iconCls":"record_edit_icon","tooltip":"修改选择的部门"},"events":{"click":"if (!app.selNode) {\n  Wb.warn('请选择 1 个部门。');\n  return;\n}\nif (app.selNode.isRoot()) {\n  Wb.warn('不能对根节点进行修改。');\n  return;\n}\napp.editWin.setTitle('修改 - ' + app.selNode.data.text);\napp.editWin.setIconCls('record_edit_icon');\nWb.setValue(app.editWin, app.selNode.data);\napp.editWin.show();\napp.isEdit = true;"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"删除","itemId":"delBtn","iconCls":"record_delete_icon","tooltip":"删除选择的部门"},"events":{"click":"if (app.tree1.selModel.isSelected(app.tree1.getRootNode())) {\n  Wb.warn('不能删除根节点。');\n  return;\n}\nWb.confirm('确定要删除选择的部门及其所属的所有子部门吗？', function() {\n  var deptIds = {};\n  Wb.each(app.tree1.getSelection(), function(node) {\n    node.cascadeBy(function(item) {\n      deptIds[item.data.DEPT_ID] = {\n        DEPT_ID: item.data.DEPT_ID\n      };\n    });\n  });\n  Wb.request({\n    url: 'm?xwl=admin/dept/delete',\n    params: {\n      deptIds: Ext.Object.getValues(deptIds)\n    },\n    success: function(resp) {\n      Wb.remove(app.tree1);\n    }\n  });\n});"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"-","itemId":"item1"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"刷新","itemId":"refreshBtn","iconCls":"refresh_icon","tooltip":"刷新部门列表"},"events":{"click":"Wb.reload(app.tree1, null, {\n  field: 'DEPT_ID'\n});"},"children":[],"expanded":false,"type":"item"}],"expanded":true,"type":"toolbar"},{"configs":{"region":"center","multiSelect":"true","root":"{\n  text: '全部',\n  DEPT_ID: '-1',\n  expanded: true\n}","itemId":"tree1","viewConfig":"app.treeViewConfig"},"events":{"itemdblclick":"app.editBtn.fireEvent('click');","selectionchange":"app.selNodes = selected;\napp.selNode = selected[0];"},"children":[{"configs":{"itemId":"store","url":"m?xwl=admin/dept/select","fields":"['text', 'DEPT_NAME', 'DEPT_ID', 'PARENT_DEPT', 'ORDER_INDEX']"},"events":{"success":"Wb.selFirst(app.tree1);"},"children":[],"expanded":false,"type":"treestore"}],"expanded":true,"type":"tree"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":"org_icon"}