{"inframe":false,"title":"用户帐户","hidden":false,"roles":{"demo":1},"children":[{"configs":{"itemId":"module"},"events":{"initialize":"Wb.apply(app, {\n  /**\n   * 获取所有模块的权限数据。\n   */\n  getPerms: function() {\n    Wb.request({\n      url: 'm?xwl=admin/user/get-perm',\n      success: function(resp) {\n        app.rolesList = Wb.decode(resp.responseText);\n      }\n    });\n  },\n  //更新当前选择用户的模块权限列表\n  setModules: function(base) {\n    var moduleRoles, hasPerm, hasAdmin = Wb.indexOf(app.currentRoles, 'admin') != -1,\n      rolesList = app.rolesList || [];\n    Ext.suspendLayouts();\n    (base || app.modules.getRootNode()).cascadeBy(function(node) {\n      if (!node.data.depth || !node.isLeaf())\n        return;\n      moduleRoles = rolesList[node.data.path];\n      if (hasAdmin)\n        hasPerm = true;\n      else {\n        hasPerm = false;\n        if (moduleRoles && app.currentRoles) {\n          Wb.each(app.currentRoles, function(role) {\n            if (moduleRoles[role]) {\n              hasPerm = true;\n              return false;\n            }\n          });\n        }\n      }\n      Wb.setChecked(node, hasPerm, true);\n    });\n    Ext.resumeLayouts(true);\n  },\n  changeUser: function(rec) {\n    if (!rec)\n      rec = app.grid1.getSelection()[0];\n    if (!app.modules.isVisible())\n      return;\n    if (!rec) {\n      app.currentRoles = null;\n      app.rolesText.setValue('');\n      Wb.setTitle(app.modules, '(未选择用户)');\n      app.setModules();\n      return;\n    }\n    if (app.request && app.request.xhr) {\n      app.noGetRoleError = true;\n      app.request.xhr.abort();\n      app.noGetRoleError = false;\n    }\n    app.request = Wb.request({\n      url: 'm?xwl=admin/user/get-role-names',\n      mask: app.modules,\n      showError: false,\n      params: {\n        USER_ID: rec.data.USER_ID\n      },\n      failure: function(resp) {\n        if (!app.noGetRoleError)\n          Wb.except(resp);\n      },\n      success: function(resp) {\n        Wb.setTitle(app.modules, rec.data.DISPLAY_NAME);\n        var rows = Wb.decode(resp.responseText).rows;\n        app.currentRoles = Ext.Array.pluck(rows, 'ROLE_ID');\n        app.currentRoles.push('default');\n        app.rolesText.setValue(Ext.Array.pluck(rows, 'ROLE_NAME').join(', '));\n        app.setModules();\n      }\n    });\n  }\n});\napp.getPerms();"},"children":[{"configs":{"height":"416","width":"648","layout":"absolute","focusControl":"USER_NAME","dialog":"true","itemId":"userWin","iconCls":"user_icon"},"events":{"hide":"Wb.reset(win);\napp.roleGrid.selModel.deselectAll();","show":"if (!win.isNew) {\n  app.PASSWORD.setValue('******');\n  app.RE_PASSWORD.setValue('******');\n}","ok":"if (app.PASSWORD.getValue() != app.RE_PASSWORD.getValue()) {\n  Wb.warn('两次密码输入不一致。',\n    function() {\n      app.PASSWORD.focus(true, true);\n    }\n  );\n  return;\n}\nwin.editHandler();"},"children":[{"configs":{"height":"22","allowBlank":"false","width":"304","labelAlign":"right","itemId":"USER_NAME","fieldLabel":"* 用户名称","y":"16","x":"0"},"children":[],"expanded":false,"type":"text"},{"configs":{"height":"22","allowBlank":"false","width":"304","labelAlign":"right","itemId":"DISPLAY_NAME","fieldLabel":"* 显示名称","y":"16","x":"312"},"children":[],"expanded":false,"type":"text"},{"configs":{"height":"22","allowBlank":"false","minLength":"6","inputType":"password","width":"304","labelAlign":"right","itemId":"PASSWORD","fieldLabel":"* 密码","y":"48","x":"0"},"children":[],"expanded":false,"type":"text"},{"configs":{"height":"22","allowBlank":"false","minLength":"6","inputType":"password","width":"304","labelAlign":"right","itemId":"RE_PASSWORD","fieldLabel":"* 密码确认","y":"48","x":"312"},"children":[],"expanded":false,"type":"text"},{"configs":{"height":"22","width":"304","vtype":"email","labelAlign":"right","itemId":"EMAIL","fieldLabel":"电子邮件","y":"80","x":"0"},"children":[],"expanded":false,"type":"text"},{"configs":{"tagConfigs":"{\n  getValue: function() {\n    var vals = Wb.getValue(this, ['radio1', 'radio2']);\n    if (vals.radio1)\n      return 1;\n    else if (vals.radio2)\n      return 0;\n    else return null;\n  },\n  setValue: function(v) {\n    Wb.setValue(this, {\n      radio1: v == 1,\n      radio2: v === 0\n    });\n  }\n}","height":"30","width":"304","layout":"hbox","labelAlign":"right","itemId":"STATUS","fieldLabel":"* 状态","y":"80","x":"312"},"children":[{"configs":{"name":"boolField","itemId":"radio1","checked":"true","boxLabel":"启用","flex":"1"},"children":[],"expanded":false,"type":"radio"},{"configs":{"name":"boolField","itemId":"radio2","boxLabel":"停用","flex":"1"},"children":[],"expanded":false,"type":"radio"}],"expanded":true,"type":"fieldcontainer"},{"configs":{"title":"角色","height":"232","layout":"fit","width":"600","itemId":"fieldset1","y":"112","x":"16"},"children":[{"configs":{"pagingBar":"false","multiSelect":"true","selType":"checkboxmodel","sortableColumns":"false","itemId":"roleGrid","simpleSelect":"true"},"children":[{"configs":{"pageSize":"-1","itemId":"store","autoLoad":"true","remoteSort":"true","url":"m?xwl=admin/user/select-valid-roles"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"fieldset"}],"expanded":false,"type":"window"},{"configs":{"layout":"border","itemId":"viewport1"},"events":{"afterrender":"app.navKey = new Ext.KeyNav({\n  viewport: app.viewport1,\n  E: {\n    ctrl: true,\n    fn: function() {\n      app.newBtn.fireEvent('click');\n    }\n  }\n});"},"children":[{"configs":{"region":"north","itemId":"mainToolbar"},"children":[{"configs":{"text":"添加","itemId":"newBtn","iconCls":"record_add_icon","tooltip":"添加新的用户 (Ctrl+E)"},"events":{"click":"Wb.insert(app.grid1, {\n  win: app._userWin, //app.userWin指向实例，销毁时会被置空。该窗口实例会随contextOwner销毁而自动销毁。\n  url: 'm?xwl=admin/user/insert'\n});"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"修改","itemId":"editBtn","iconCls":"record_edit_icon","tooltip":"修改选择的用户"},"events":{"click":"var rec = app.grid1.getSelection()[0];\nif (rec) {\n  Wb.request({\n    url: 'm?xwl=admin/user/get-roles',\n    params: {\n      USER_ID: rec.data.USER_ID\n    },\n    success: function(resp) {\n      Wb.edit(app.grid1, {\n        win: app._userWin,\n        titleField: 'DISPLAY_NAME',\n        url: 'm?xwl=admin/user/update',\n        success: function() {\n          app.changeUser();\n        }\n      });\n      var roleRec, selRecs = [],\n        roles = Wb.decode(resp.responseText);\n      Wb.each(roles.rows, function(rec) {\n        roleRec = Wb.find(app.roleGrid.store, 'ROLE_ID', rec.ROLE_ID);\n        if (roleRec)\n          selRecs.push(roleRec);\n      });\n      app.roleGrid.setSelection(selRecs);\n      app.USER_NAME.focus(false, true);\n    }\n  });\n} else Wb.edit(app.grid1); //仅用于提示用户选择记录"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"删除","itemId":"delBtn","iconCls":"record_delete_icon","tooltip":"删除选择的用户"},"events":{"click":"Wb.del(app.grid1, {\n  url: 'm?xwl=admin/user/delete',\n  titleField: 'DISPLAY_NAME'\n});"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"-","itemId":"item1"},"children":[],"expanded":false,"type":"item"},{"configs":{"enterKeyTriggerClick":"true","displayField":"USER_NAME","triggerCls":"x-form-search-trigger","width":"200","emptyText":"用户名称","itemId":"findCombo","onTriggerClick":"this.collapse();\nif (app.selRoleGrid.rendered)\n  app.selRoleGrid.selModel.deselectAll();\napp.grid1.store.load({\n  out: app.mainToolbar\n});"},"events":{"select":"app.findCombo.onTriggerClick();"},"children":[{"configs":{"itemId":"store","url":"m?xwl=admin/user/user-list"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"},{"configs":{"text":"搜索角色","itemId":"rolesMenu","iconCls":"user_group_icon"},"children":[{"configs":{"pagingBar":"false","multiSelect":"true","height":"230","selType":"checkboxmodel","width":"500","sortableColumns":"false","itemId":"selRoleGrid","simpleSelect":"true"},"events":{"selectionchange":"app.grid1.store.load({\n  out: app.selRoleGrid\n});"},"children":[{"configs":{"pageSize":"-1","itemId":"store","autoLoad":"true","remoteSort":"true","url":"m?xwl=admin/user/select-all-roles"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"item"},{"configs":{"text":"重置搜索","itemId":"resetFindBtn","iconCls":"undo_icon","tooltip":"重置搜索条件"},"events":{"click":"if (app.selRoleGrid.rendered)\n  app.selRoleGrid.selModel.deselectAll();\nWb.reset(app.mainToolbar);\napp.grid1.store.load();"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"-","itemId":"item2"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"角色权限","itemId":"rolesBtn","iconCls":"option_icon","tooltip":"查看/隐藏选择用户的角色和权限"},"events":{"click":"var notVisible = !app.modules.isVisible();\napp.modules.setVisible(notVisible);\nif (notVisible)\n  app.changeUser();"},"children":[],"expanded":false,"type":"item"}],"expanded":true,"type":"toolbar"},{"configs":{"rootVisible":"false","region":"east","multiSelect":"true","title":"查看角色权限 - (未选择用户)","closable":"true","root":"{\n  fileName: 'Root'\n}","width":"380","closeAction":"hide","split":"true","itemId":"modules"},"events":{"itemexpand":"app.setModules(node);"},"children":[{"configs":{"itemId":"store","url":"m?xwl=admin/user/module-list","fields":"['text', 'path', 'fileName']"},"events":{"beforeload":"operation.params.path = operation.node.data.path;"},"children":[],"expanded":false,"type":"treestore"},{"configs":{"itemId":"dockedItems"},"children":[{"configs":{"itemId":"toolbar1"},"children":[{"configs":{"text":"角色：","itemId":"rolesLbl","padding":"0 0 0 4"},"children":[],"expanded":false,"type":"label"},{"configs":{"readOnly":"true","itemId":"rolesText","flex":"1"},"children":[],"expanded":false,"type":"text"}],"expanded":true,"type":"toolbar"},{"configs":{"enableOverflow":"true","itemId":"toolbar2"},"children":[{"configs":{"enterKeyTriggerClick":"true","displayField":"title","triggerCls":"x-form-search-trigger","valueField":"fullFile","listConfig":"{\n  itemTpl: [\n    '<div>{fullPath}<\/div>'\n  ]\n}","emptyText":"模块","itemId":"combo","flex":"1","onTriggerClick":"app.modules.selectPath('/Root/' + this.getValue(), 'fileName');"},"events":{"select":"combo.onTriggerClick();","beforequery":"if (plan.query.indexOf('/') != -1 || plan.query.indexOf('\\\\') != -1) {\n  plan.combo.collapse();\n  return false;\n}"},"children":[{"configs":{"itemId":"store","url":"m?xwl=admin/user/search-module","fields":"['path', 'title', 'file', 'parentFile', {\n  name: 'fullPath',\n  convert: function(v, rec) {\n    var data = rec.data;\n    if (data.path)\n      return data.path.substring(1) + '/' + data.title;\n    else return data.title;\n  }\n}, {\n  name: 'fullFile',\n  convert: function(v, rec) {\n    var data = rec.data;\n    if (data.parentFile)\n      return data.parentFile.substring(1) + '/' + data.file;\n    else return data.file;\n  }\n}]"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"},{"configs":{"text":"-","itemId":"item"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"展开","itemId":"expandAllBtn","iconCls":"plus_icon","tooltip":"展开选择模块的全部子模块"},"events":{"click":"Wb.expand(app.modules);"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"收缩","itemId":"collapseAllBtn","iconCls":"minus_icon","tooltip":"收缩选择模块的全部子模块"},"events":{"click":"Wb.collapse(app.modules);"},"children":[],"expanded":false,"type":"item"}],"expanded":true,"type":"toolbar"}],"expanded":true,"type":"array"}],"expanded":true,"type":"tree"},{"configs":{"region":"center","multiSelect":"true","itemId":"grid1"},"events":{"itemdblclick":"app.editBtn.fireEvent('click');","selectionchange":"app.changeUser(selected[0]);"},"children":[{"configs":{"sorters":"'USER_NAME'","autoLoad":"true","itemId":"store","remoteSort":"true","url":"m?xwl=admin/user/select"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":"user_icon"}