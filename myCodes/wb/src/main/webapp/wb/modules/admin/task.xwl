{"inframe":false,"title":"计划任务","hidden":false,"roles":{"demo":1},"children":[{"configs":{"itemId":"module"},"events":{"finalize":"app.setButtons();","initialize":"Wb.apply(app, {\n  enabled: '{#Var.sys.task.enabled#}' == 'true',\n  weekDays: [\n    [1, '日'],\n    [2, '一'],\n    [3, '二'],\n    [4, '三'],\n    [5, '四'],\n    [6, '五'],\n    [7, '六']\n  ],\n  /**\n   * 搜索指定名称的计划任务。\n   * @param {Boolean} reset 是否重置搜索结果。\n   */\n  search: function(reset) {\n    app.searchCombo.collapse();\n    app.taskStore.load(reset ? null : {\n      out: app.grid1.down('toolbar')\n    });\n  },\n  /**\n   * 创建任务编辑窗口。\n   * @param {Function} callback 创建完成后执行的回调函数。\n   */\n  createWin: function(callback) {\n    function create() {\n      if (!(app.editWin instanceof Ext.window.Window)) {\n        new Ext.window.Window(app._editWin);\n        var config, panel = app.scriptPanel;\n        panel.update('<textarea><\/textarea>');\n        config = {\n          lineNumbers: true,\n          theme: Wb.editTheme,\n          highlightSelectionMatches: {\n            showToken: /\\w/\n          },\n          mode: {\n            name: 'text/javascript',\n            globalVars: true\n          },\n          gutters: ['CodeMirror-lint-markers'],\n          lint: true,\n          matchBrackets: true,\n          extraKeys: {\n            'Ctrl-/': 'toggleComment',\n            'Ctrl-.': function(doc) {\n              if (doc.modifyCursor)\n                doc.setCursor(doc.modifyCursor);\n            },\n            'Shift-Ctrl-F': function(doc) {\n              if (doc.options.readOnly)\n                return;\n              var cursor = doc.getCursor(),\n                scroll = doc.getScrollInfo();\n              doc.autoFormatRange({\n                line: 0,\n                ch: 0\n              }, {\n                line: Number.MAX_VALUE,\n                ch: Number.MAX_VALUE\n              });\n              doc.scrollTo(scroll.left, scroll.top);\n              doc.setCursor(cursor);\n            }\n          }\n        };\n        config.extraKeys['Alt-/'] = 'autocomplete';\n        app.scriptEditor = CodeMirror.fromTextArea(panel.el.down('textarea', true), config);\n        panel.mon(panel, 'resize', function(panel, width, height) {\n          if (app.scriptEditor && !panel.destroying) {\n            Ext.fly(app.scriptEditor.getScrollerElement()).setHeight(height);\n            app.scriptEditor.refresh();\n          }\n        });\n      }\n      Ext.callback(callback);\n    }\n    if (window.CodeMirror)\n      create();\n    else {\n      Wb.addLink(['wb/libs/cm/cmirror.css', 'wb/libs/cm/cmirror.js'],\n        create\n      );\n    }\n  },\n  checkSelection: function() {\n    if (app.grid1.getSelection().length === 0) {\n      Wb.warn('请选择至少1个计划任务。');\n      return false;\n    }\n    return true;\n  },\n  setButtons: function() {\n    app.startBtn.setDisabled(app.enabled);\n    app.stopBtn.setDisabled(!app.enabled);\n    app.resumeBtn.setDisabled(!app.enabled);\n    app.pauseBtn.setDisabled(!app.enabled);\n  }\n});"},"children":[{"configs":{"autoShow":"true","height":"500","layout":"fit","width":"712","focusControl":"TASK_NAME","resizable":"true","closeAction":"hide","itemId":"editWin","dialog":"true","createInstance":"false","maximizable":"true"},"events":{"hide":"Wb.reset(win);\napp.scriptEditor.setValue('');","ok":"var intervalType = app.INTERVAL_TYPE.getValue(),\n  intervalExpress, val = app.intervalNumber.getValue(),\n  time = app.intervalTime.getValue();\ntime = time ? Wb.format(time, 'H:i') : '';\napp.SERVER_SCRIPT.setValue(app.scriptEditor.getValue());\nswitch (intervalType) {\n  case 0:\n  case 1:\n  case 2:\n    intervalExpress = val;\n    break;\n  case 3:\n    intervalExpress = time;\n    break;\n  case 4:\n    intervalExpress = app.weekdaysCombo.getValue() + ':' + time;\n    break;\n  case 5:\n    intervalExpress = val + ':' + time;\n    break;\n}\napp.INTERVAL_EXPRESS.setValue(intervalExpress.toString());\nwin.editHandler();"},"children":[{"configs":{"deferredRender":"false","transparent":"true","itemId":"propertyTab"},"children":[{"configs":{"title":"常规","height":"264","layout":"absolute","width":"688","transparent":"true","itemId":"generalPage","iconCls":"property_icon"},"children":[{"configs":{"text":"* 任务名称：","height":"22","width":"80","labelAlign":"right","itemId":"taskNameLbl","y":"16","x":"16"},"children":[],"expanded":false,"type":"label"},{"configs":{"height":"22","allowBlank":"false","width":"568","labelAlign":"right","itemId":"TASK_NAME","y":"16","x":"104"},"children":[],"expanded":false,"type":"text"},{"configs":{"text":"* 周期：","height":"22","width":"80","labelAlign":"right","itemId":"intervalLbl","y":"48","x":"16"},"children":[],"expanded":false,"type":"label"},{"configs":{"height":"22","allowBlank":"false","width":"568","itemId":"INTERVAL_TYPE","y":"48","x":"104"},"events":{"change":"var i = radiogroup.getValue();\napp.prefixLabel.setVisible(i != 3);\napp.intervalNumber.setVisible(i != 3 && i != 4);\napp.weekdaysCombo.setVisible(i == 4);\napp.suffixLabel.setVisible(i < 3);\napp.spaceLabel.setVisible(i != 3);\napp.timeLabel.setVisible(i > 2);\napp.intervalTime.setVisible(i > 2);\nswitch (i) {\n  case 0:\n    app.prefixLabel.setText('每');\n    app.suffixLabel.setText('秒');\n    break;\n  case 1:\n    app.prefixLabel.setText('每');\n    app.suffixLabel.setText('分');\n    break;\n  case 2:\n    app.prefixLabel.setText('每');\n    app.suffixLabel.setText('小时');\n    break;\n  case 4:\n    app.prefixLabel.setText('周：');\n    break;\n  case 5:\n    app.prefixLabel.setText('日期：');\n    break;\n}"},"children":[{"configs":{"name":"intervalType","itemId":"radio1","boxLabel":"秒"},"children":[],"expanded":false,"type":"radio"},{"configs":{"name":"intervalType","itemId":"radio2","boxLabel":"分"},"children":[],"expanded":false,"type":"radio"},{"configs":{"name":"intervalType","itemId":"radio3","boxLabel":"时"},"children":[],"expanded":false,"type":"radio"},{"configs":{"name":"intervalType","itemId":"radio4","boxLabel":"日"},"children":[],"expanded":false,"type":"radio"},{"configs":{"name":"intervalType","itemId":"radio5","boxLabel":"周"},"children":[],"expanded":false,"type":"radio"},{"configs":{"name":"intervalType","itemId":"radio6","boxLabel":"月"},"children":[],"expanded":false,"type":"radio"}],"expanded":false,"type":"radiogroup"},{"configs":{"height":"22","layout":"column","width":"568","itemId":"intervalSet","y":"80","x":"104"},"children":[{"configs":{"itemId":"prefixLabel","padding":"0 8 0 0"},"children":[],"expanded":false,"type":"label"},{"configs":{"allowBlank":"false","width":"100","itemId":"intervalNumber","allowDecimals":"false"},"children":[],"expanded":false,"type":"number"},{"configs":{"allowBlank":"false","width":"100","pickList":"app.weekDays","itemId":"weekdaysCombo","forceSelection":"true"},"children":[],"expanded":false,"type":"combo"},{"configs":{"itemId":"suffixLabel","padding":"0 0 0 8"},"children":[],"expanded":false,"type":"label"},{"configs":{"itemId":"spaceLabel","padding":"0 24 0 0"},"children":[],"expanded":false,"type":"label"},{"configs":{"text":"时间：","itemId":"timeLabel","padding":"0 8 0 0"},"children":[],"expanded":false,"type":"label"},{"configs":{"allowBlank":"false","width":"100","format":"H:i","itemId":"intervalTime"},"children":[],"expanded":false,"type":"time"}],"expanded":true,"type":"container"},{"configs":{"text":"开始时间：","height":"22","width":"80","labelAlign":"right","itemId":"beginLbl","y":"112","x":"16"},"children":[],"expanded":false,"type":"label"},{"configs":{"height":"22","width":"240","timeFormat":"H:i:s","dateFormat":"Y-m-d","labelAlign":"right","itemId":"BEGIN_DATE","y":"112","x":"104"},"events":{"change":"app.END_DATE.dateField.setMinValue(app.BEGIN_DATE.dateField.getValue());"},"children":[],"expanded":false,"type":"datetime"},{"configs":{"text":"结束时间：","height":"22","width":"72","labelAlign":"right","itemId":"endLbl","y":"112","x":"352"},"children":[],"expanded":false,"type":"label"},{"configs":{"height":"22","width":"240","timeFormat":"H:i:s","dateFormat":"Y-m-d","labelAlign":"right","itemId":"END_DATE","y":"112","x":"432"},"children":[],"expanded":false,"type":"datetime"},{"configs":{"text":"类全名：","height":"22","width":"80","labelAlign":"right","itemId":"classLbl","y":"144","x":"16"},"children":[],"expanded":false,"type":"label"},{"configs":{"height":"22","width":"568","itemId":"CLASS_NAME","y":"144","x":"104"},"children":[],"expanded":false,"type":"text"},{"configs":{"text":"备注：","height":"22","width":"80","labelAlign":"right","itemId":"remarkLbl","y":"176","x":"16"},"children":[],"expanded":false,"type":"label"},{"configs":{"height":"22","width":"568","labelAlign":"right","itemId":"REMARK","y":"176","x":"104"},"children":[],"expanded":false,"type":"text"},{"configs":{"height":"22","width":"100","itemId":"INTERVAL_EXPRESS","y":"200","x":"104"},"children":[],"expanded":false,"type":"hidden"},{"configs":{"height":"22","width":"100","itemId":"STATUS","y":"200","x":"240"},"children":[],"expanded":false,"type":"hidden"},{"configs":{"height":"22","width":"100","itemId":"SERVER_SCRIPT","y":"200","x":"368"},"children":[],"expanded":false,"type":"hidden"}],"expanded":true,"type":"panel"},{"configs":{"title":"脚本","itemId":"scriptPanel","iconCls":"file_ss_icon"},"events":{"activate":"setTimeout(function() {\n  app.scriptEditor.refresh();\n  app.scriptEditor.focus();\n}, 10);"},"children":[],"expanded":false,"type":"panel"}],"expanded":true,"type":"tab"}],"expanded":true,"type":"window"},{"configs":{"layout":"fit","itemId":"viewport1"},"events":{"afterrender":"app.navKey = new Ext.KeyNav({\n  viewport: app.viewport1,\n  E: {\n    ctrl: true,\n    fn: function() {\n      app.newBtn.fireEvent('click');\n    }\n  }\n});"},"children":[{"configs":{"multiSelect":"true","pagingBar":"false","itemId":"grid1"},"events":{"itemdblclick":"app.editBtn.fireEvent('click');"},"children":[{"configs":{"pageSize":"-1","normalName":"taskStore","itemId":"store","autoLoad":"true","url":"m?xwl=admin/task/get-tasks","fields":"['TASK_ID', 'TASK_NAME', 'INTERVAL_TYPE', 'INTERVAL_EXPRESS',\n  'CLASS_NAME', 'SERVER_SCRIPT',\n  'STATUS', 'REMARK', {\n    name: 'BEGIN_DATE',\n    dateFormat: Wb.dateFormat,\n    type: 'date'\n  }, {\n    name: 'END_DATE',\n    dateFormat: Wb.dateFormat,\n    type: 'date'\n  }, {\n    name: 'PREVIOUS',\n    dateFormat: Wb.dateFormat,\n    type: 'date'\n  }, {\n    name: 'NEXT',\n    dateFormat: Wb.dateFormat,\n    type: 'date'\n  }\n]"},"children":[],"expanded":false,"type":"store"},{"configs":{"itemId":"tbar"},"children":[{"configs":{"text":"添加","itemId":"newBtn","iconCls":"record_add_icon","tooltip":"添加新的计划任务 (Ctrl+E)"},"events":{"click":"app.createWin(function(win) {\n  app.STATUS.setValue(1);\n  Wb.insert(app.grid1, {\n    win: app.editWin,\n    url: 'm?xwl=admin/task/insert'\n  });\n  app.propertyTab.setActiveTab(app.generalPage);\n  app.INTERVAL_TYPE.setValue(3);\n});"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"修改","itemId":"editBtn","iconCls":"record_edit_icon","tooltip":"修改选择的计划任务"},"events":{"click":"if (!app.checkSelection())\n  return;\napp.createWin(function(win) {\n  Wb.edit(app.grid1, {\n    win: app.editWin,\n    titleField: 'TASK_NAME',\n    url: 'm?xwl=admin/task/update'\n  });\n  app.scriptEditor.setValue(app.SERVER_SCRIPT.getValue() || '');\n  var i = app.INTERVAL_TYPE.getValue(),\n    v = app.INTERVAL_EXPRESS.getValue().split(':'),\n    setTime = function() {\n      app.intervalTime.setValue(Ext.Date.parse(v[1] + ':' + v[2], 'H:i'));\n    };\n  switch (i) {\n    case 0:\n    case 1:\n    case 2:\n      app.intervalNumber.setValue(v[0]);\n      break;\n    case 3:\n      app.intervalTime.setValue(Ext.Date.parse(v[0] + ':' + v[1], 'H:i'));\n      break;\n    case 4:\n      app.weekdaysCombo.setValue(parseInt(v[0], 10));\n      setTime();\n      break;\n    case 5:\n      app.intervalNumber.setValue(v[0]);\n      setTime();\n      break;\n  }\n});"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"删除","itemId":"delBtn","iconCls":"record_delete_icon","tooltip":"删除选择的计划任务"},"events":{"click":"Wb.del(app.grid1, {\n  url: 'm?xwl=admin/task/delete',\n  titleField: 'TASK_NAME'\n});"},"children":[],"expanded":true,"type":"item"},{"configs":{"text":"-","itemId":"item1"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"暂停","itemId":"pauseBtn","iconCls":"pause_icon","tooltip":"暂停执行所有选择的计划任务"},"events":{"click":"if (!app.checkSelection())\n  return;\nWb.request({\n  url: 'm?xwl=admin/task/pause',\n  out: app.grid1,\n  success: function(resp) {\n    var rows = app.grid1.getSelection(),\n      rec = {\n        STATUS: 0,\n        PREVIOUS: null,\n        NEXT: null\n      };\n    Wb.each(rows, function(row) {\n      Wb.update(row, rec);\n    });\n  }\n});"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"恢复","itemId":"resumeBtn","iconCls":"resume_icon","tooltip":"恢复执行所有选择的计划任务"},"events":{"click":"if (!app.checkSelection())\n  return;\nWb.request({\n  url: 'm?xwl=admin/task/resume',\n  out: app.grid1,\n  success: function(resp) {\n    var rows = app.grid1.getSelection(),\n      recs = Wb.decode(resp.responseText),\n      index = 0;\n    Wb.each(rows, function(row) {\n      Wb.update(row, recs[index++]);\n    });\n  }\n});"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"-","itemId":"item2"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"刷新","itemId":"refreshBtn","iconCls":"refresh_icon","tooltip":"刷新计划任务列表"},"events":{"click":"app.taskStore.reload();"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"-","itemId":"item3"},"children":[],"expanded":false,"type":"item"},{"configs":{"displayField":"TASK_NAME","enterKeyTriggerClick":"true","triggerCls":"x-form-search-trigger","width":"230","emptyText":"任务名称","itemId":"searchCombo","onTriggerClick":"app.search();"},"events":{"select":"app.search();"},"children":[{"configs":{"itemId":"store","url":"m?xwl=admin/task/search"},"children":[],"expanded":false,"type":"store"}],"expanded":true,"type":"combo"},{"configs":{"itemId":"resetSearchBtn","iconCls":"undo_icon","tooltip":"重置搜索条件"},"events":{"click":"app.search(true);"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"->","itemId":"item4"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"启动引擎","itemId":"startBtn","iconCls":"run_icon","tooltip":"启动计划任务引擎并恢复所有已经启用任务的执行"},"events":{"click":"Wb.request({\n  url: 'm?xwl=admin/task/start',\n  success: function(resp) {\n    app.enabled = true;\n    app.setButtons();\n    app.taskStore.reload();\n  }\n});"},"children":[],"expanded":false,"type":"item"},{"configs":{"text":"停止引擎","itemId":"stopBtn","iconCls":"stop_icon","tooltip":"停止所有任务的执行并关闭计划任务引擎"},"events":{"click":"Wb.request({\n  url: 'm?xwl=admin/task/stop',\n  success: function(resp) {\n    app.enabled = false;\n    app.setButtons();\n    app.taskStore.reload();\n  }\n});"},"children":[],"expanded":false,"type":"item"}],"expanded":true,"type":"toolbar"},{"configs":{"itemId":"columns"},"children":[{"configs":{"xtype":"rownumberer","itemId":"numCol"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"名称","width":"230","autoWrap":"true","dataIndex":"TASK_NAME","itemId":"nameCol","renderer":"var s = record.get('STATUS');\nreturn Wb.getIcon(['lamp_red_icon', 'lamp_green_icon'][s], ['停用', '启用'][s]) + value;"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"周期","width":"110","autoWrap":"true","dataIndex":"INTERVAL_TYPE","itemId":"intervalTypeCol","renderer":"var name = ['秒', '分', '时', '日', '周', '月'][value],\n  express = record.get('INTERVAL_EXPRESS').split(':'),\n  text, date;\ntry {\n  switch (value) {\n    case 0:\n    case 1:\n    case 2:\n      text = '每 ' + express[0] + ' ' + name;\n      break;\n    case 3:\n      text = '每日 ' + express[0] + ':' + express[1];\n      break;\n    case 4:\n    case 5:\n      if (value == 4) text = app.weekDays[parseInt(express[0], 10) - 1][1];\n      else text = express[0];\n      date = new Date();\n      date.setHours(parseInt(express[1], 10), parseInt(express[2], 10), 0, 0);\n      if (value == 4)\n        text = '每周' + text + ' ' + Wb.dateToText(date, true);\n      else\n        text = '每月 ' + text + ' 日 ' + Wb.dateToText(date, true);\n  }\n} catch (e) {\n  text = '无效周期';\n}\nreturn text;"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"运行时间","width":"170","autoWrap":"true","dataIndex":"PREVIOUS","itemId":"fireTimeCol","renderer":"var previous = Wb.format(record.get('PREVIOUS'), 'Y-m-d H:i:s') || '',\n  next = Wb.format(record.get('NEXT'), 'Y-m-d H:i:s') || '';\nif (!previous && !next)\n  return '&nbsp;<br>&nbsp;';\nelse\n  return '上次：' + previous + '<br>下次：' + next;"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"起止时间","width":"170","autoWrap":"true","dataIndex":"BEGIN_DATE","itemId":"rangeTimeCol","renderer":"var begin = Wb.format(record.get('BEGIN_DATE'), 'Y-m-d H:i:s') || '',\n  end = Wb.format(record.get('END_DATE'), 'Y-m-d H:i:s') || '';\nif (!begin && !end)\n  return '&nbsp;<br>&nbsp;';\nelse\n  return '开始：' + begin + '<br>结束：' + end;"},"children":[],"expanded":false,"type":"column"},{"configs":{"text":"备注","dataIndex":"REMARK","itemId":"remarkCol","flex":"1"},"children":[],"expanded":false,"type":"column"}],"expanded":true,"type":"array"}],"expanded":true,"type":"grid"}],"expanded":true,"type":"viewport"}],"expanded":true,"type":"module"}],"pageLink":"","iconCls":"time_icon"}