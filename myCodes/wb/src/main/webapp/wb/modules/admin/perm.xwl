{"title":"权限设置","inframe":false,"hidden":false,"roles":{"demo":1},"pageLink":"","children":[{"configs":{"itemId":"module"},"events":{"initialize":"Wb.apply(app, {\n  /**\n   * 获取所有模块的权限数据。\n   */\n  getPerms: function() {\n    Wb.request({\n      url: 'm?xwl=admin/perm/get-perm',\n      success: function(resp) {\n        app.rolesList = Wb.decode(resp.responseText);\n      }\n    });\n  },\n  /**\n   * 设置模块权限，并立即设置写入后台。\n   * @param {NodeInterface} node 节点。\n   * @param {Boolean} checked 选择状态。\n   * @param {Boolean} fromRole 指定是否从角色控件来设置权限。\n   */\n  setModulePerms: function(node, checked, fromRole) {\n    var role = fromRole ? node.data.ROLE_ID : app.currentRole,\n      path = fromRole ? app.currentModule : node.data.path;\n    Wb.setChecked(node, !checked);\n    Wb.request({\n      url: 'm?xwl=admin/perm/set-perms',\n      params: {\n        path: [path],\n        role: role,\n        checked: checked\n      },\n      success: function() {\n        var roles = app.rolesList[path];\n        if (checked) {\n          if (!roles) {\n            roles = {};\n            app.rolesList[path] = roles;\n          }\n          roles[role] = 1;\n        } else {\n          if (roles)\n            delete roles[role];\n        }\n        Wb.setChecked(node, checked);\n        if (fromRole)\n          app.setModules(app.currentModuleNode);\n        else app.setRoles(node);\n      }\n    });\n  },\n  /**\n   * 设置批量模块权限，并立即设置写入后台。\n   * @param {Boolean} checked 选择状态。\n   */\n  setBatchPerms: function(checked) {\n    var sels = app.modules.getSelection();\n    Wb.confirmDo(sels, function() {\n      Wb.request({\n        url: 'm?xwl=admin/perm/set-perms',\n        params: {\n          path: Wb.pluck(sels, 'path'),\n          role: app.currentRole,\n          checked: checked\n        },\n        success: function() {\n          var roles, path;\n          Ext.suspendLayouts();\n          Wb.each(sels, function(node) {\n            if (!node.isLeaf())\n              return;\n            path = node.data.path;\n            roles = app.rolesList[path];\n            if (checked) {\n              if (!roles) {\n                roles = {};\n                app.rolesList[path] = roles;\n              }\n              roles[app.currentRole] = 1;\n            } else {\n              if (roles)\n                delete roles[app.currentRole];\n            }\n            Wb.setChecked(node, checked);\n            app.setRoles(node);\n          });\n          Ext.resumeLayouts(true);\n        }\n      });\n    }, 'text', checked ? Str.permit : Str.prohibit);\n  },\n  /**\n   * 设置指定节点及其所有子节点的模块权限视图。\n   * @param {NodeInterface} [base] 指定设置该节点及其所有子节点。如果为空设置所有节点。\n   */\n  setModules: function(base) {\n    var hasPerm, roles,\n      rolesList = app.rolesList;\n    Ext.suspendLayouts();\n    (base || app.modules.getRootNode()).cascadeBy(function(node) {\n      if (!node.data.depth || !node.isLeaf())\n        return;\n      roles = rolesList[node.data.path];\n      hasPerm = roles && roles[app.currentRole] == 1;\n      Wb.setChecked(node, hasPerm);\n    });\n    Ext.resumeLayouts(true);\n  },\n  /**\n   * 设置指定模块可访问角色的权限视图。\n   * @param {NodeInterface} node 模块节点。\n   */\n  setRoles: function(node) {\n    var roles = app.rolesList[node.data.path] || {};\n    Ext.suspendLayouts();\n    app.allows.getRootNode().eachChild(function(node) {\n      Wb.setChecked(node, roles[node.data.ROLE_ID]);\n    });\n    Ext.resumeLayouts(true);\n  }\n});\napp.getPerms();"},"children":[{"configs":{"layout":"border","itemId":"viewport1"},"children":[{"configs":{"region":"west","rootVisible":"false","title":"角色列表","collapsible":"true","width":"200","split":"true","itemId":"roles"},"events":{"selectionchange":"var role = selected[0];\nif (role) {\n  app.modules.setDisabled(false);\n  app.currentRole = role.data.ROLE_ID;\n  app.setModules();\n}"},"children":[{"configs":{"itemId":"store","url":"m?xwl=admin/perm/role-list"},"children":[],"type":"treestore","expanded":false}],"type":"tree","expanded":true},{"configs":{"rootVisible":"false","region":"center","multiSelect":"true","root":"{\n  fileName: 'Root'\n}","itemId":"modules","disabled":"true"},"events":{"checkchange":"app.setModulePerms(node, checked, false);","itemexpand":"if (app.currentRole)\n  app.setModules(node); //必须每次展现后进行设置，因为收缩时跳过设置","selectionchange":"var module = selected[0],\n  valid = module && module.isLeaf();\napp.allows.setDisabled(!valid);\nif (valid) {\n  app.allows.setDisabled(false);\n  app.currentModuleNode = module;\n  app.currentModule = module.data.path;\n  Wb.setTitle(app.allows, module.data.text);\n  app.setRoles(module);\n}"},"children":[{"configs":{"itemId":"store","url":"m?xwl=admin/perm/module-list","fields":"['text', 'path', 'fileName']"},"events":{"beforeload":"operation.params.path = operation.node.data.path;"},"children":[],"type":"treestore","expanded":false},{"configs":{"enableOverflow":"true","itemId":"tbar"},"children":[{"configs":{"text":"批量允许","itemId":"permitBatchBtn","iconCls":"application_add_icon","tooltip":"允许访问选择的所有模块 (Ctrl/Shift 多选)"},"events":{"click":"app.setBatchPerms(true);"},"children":[],"type":"item","expanded":true},{"configs":{"text":"批量禁止","itemId":"prohibitBatchBtn","iconCls":"application_delete_icon","tooltip":"禁止访问选择的所有模块 (Ctrl/Shift 多选)"},"events":{"click":"app.setBatchPerms(false);"},"children":[],"type":"item","expanded":true},{"configs":{"text":"-","itemId":"item1"},"children":[],"type":"item","expanded":false},{"configs":{"text":"全部展开","itemId":"expandAllBtn","iconCls":"plus_icon","tooltip":"展开选择模块的全部子模块"},"events":{"click":"Wb.expand(app.modules);"},"children":[],"type":"item","expanded":false},{"configs":{"text":"全部收缩","itemId":"collapseAllBtn","iconCls":"minus_icon","tooltip":"收缩选择模块的全部子模块"},"events":{"click":"Wb.collapse(app.modules);"},"children":[],"type":"item","expanded":false},{"configs":{"text":"-","itemId":"item2"},"children":[],"type":"item","expanded":true},{"configs":{"enterKeyTriggerClick":"true","displayField":"title","triggerCls":"x-form-search-trigger","valueField":"fullFile","listConfig":"{\n  itemTpl: [\n    '<div>{fullPath}<\/div>'\n  ]\n}","emptyText":"模块","itemId":"combo","flex":"1","onTriggerClick":"app.modules.selectPath('/Root/' + this.getValue(), 'fileName');"},"events":{"select":"combo.onTriggerClick();","beforequery":"if (plan.query.indexOf('/') != -1 || plan.query.indexOf('\\\\') != -1) {\n  plan.combo.collapse();\n  return false;\n}"},"children":[{"configs":{"itemId":"store","url":"m?xwl=admin/perm/search-module","fields":"['path', 'title', 'file', 'parentFile', {\n  name: 'fullPath',\n  convert: function(v, rec) {\n    var data = rec.data;\n    if (data.path)\n      return data.path.substring(1) + '/' + data.title;\n    else return data.title;\n  }\n}, {\n  name: 'fullFile',\n  convert: function(v, rec) {\n    var data = rec.data;\n    if (data.parentFile)\n      return data.parentFile.substring(1) + '/' + data.file;\n    else return data.file;\n  }\n}]"},"children":[],"type":"store","expanded":false}],"type":"combo","expanded":true}],"type":"toolbar","expanded":true}],"type":"tree","expanded":true},{"configs":{"region":"east","rootVisible":"false","title":"可访问","collapsible":"true","width":"260","split":"true","itemId":"allows","disabled":"true"},"events":{"checkchange":"app.setModulePerms(node, checked, true);"},"children":[{"configs":{"itemId":"store","url":"m?xwl=admin/perm/module-role-list"},"children":[],"type":"treestore","expanded":false}],"type":"tree","expanded":true}],"type":"viewport","expanded":true}],"type":"module","expanded":true}],"iconCls":"option_icon"}